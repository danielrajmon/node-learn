apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: node-learn
data:
  01-init-databases.sh: |
    #!/bin/bash
    set -e

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color

    # Database names
    DATABASES=("auth" "questions" "quiz" "achievements" "leaderboard" "admin" "maintenance")

    echo "====================================="
    echo "Node Learn - Database Initialization"
    echo "====================================="
    echo ""

    # Function to create database if it doesn't exist
    create_database() {
        local db_name=$1
        
        # Check if database exists
        if psql -U "$POSTGRES_USER" -lqt | cut -d \| -f 1 | grep -qw "$db_name"; then
            echo -e "${YELLOW}⚠ Database '$db_name' already exists, skipping...${NC}"
        else
            echo -e "${GREEN}✓ Creating database '$db_name'...${NC}"
            psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
                CREATE DATABASE $db_name OWNER $POSTGRES_USER;
                GRANT ALL PRIVILEGES ON DATABASE $db_name TO $POSTGRES_USER;
EOSQL
            echo -e "${GREEN}✓ Database '$db_name' created successfully${NC}"
        fi
    }

    # Create all service databases
    for db in "${DATABASES[@]}"; do
        create_database "$db"
    done

    echo ""
    echo -e "${GREEN}====================================="
    echo "✓ Database initialization complete"
    echo "=====================================${NC}"
    echo ""
    echo "Created databases:"
    for db in "${DATABASES[@]}"; do
        echo "  - $db"
    done
    echo ""
