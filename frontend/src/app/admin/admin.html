<div class="admin-container">
  <div class="header">
    <h1>{{ isEditMode ? 'Edit Question' : 'Create Questions' }}</h1>
  </div>

  <div class="success-message" *ngIf="successMessage">
    {{ successMessage }}
  </div>

  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <form (ngSubmit)="onSubmit()" #questionForm="ngForm" class="question-form">
    <div class="form-layout">
      <div class="form-left">
        <div class="form-group">
          <label for="questionText">Question Text</label>
          <quill-editor
            id="questionText"
            name="questionText"
            [(ngModel)]="question.questionText"
            [modules]="quillModules"
            [styles]="{ height: '150px' }"
            placeholder="Enter your question here..."
            [required]="true"
            format="html"
          ></quill-editor>
        </div>

        <div class="form-group">
          <label for="longAnswer">Answer</label>
          <quill-editor
            id="longAnswer"
            name="longAnswer"
            [(ngModel)]="question.longAnswer"
            [modules]="quillModules"
            [styles]="{ height: '300px' }"
            placeholder="Enter the detailed answer..."
            [required]="true"
            format="html"
          ></quill-editor>
        </div>

        <div class="form-group">
          <label for="difficulty">Difficulty</label>
          <select
            id="difficulty"
            name="difficulty"
            [(ngModel)]="question.difficulty"
            required
          >
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>

        <div class="form-group">
          <label for="topic">Topic</label>
          <input
            type="text"
            id="topic"
            name="topic"
            [(ngModel)]="question.topic"
            list="topicOptions"
            required
            maxlength="100"
            placeholder="Select or type topic"
          />
          <datalist id="topicOptions">
            <option *ngFor="let topic of allTopics" [value]="topic">{{ topic }}</option>
          </datalist>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input
              type="checkbox"
              name="isActive"
              [(ngModel)]="question.isActive"
            />
            Active (visible to users)
          </label>
        </div>

        <div class="form-group">
          <label for="questionType">Question Type</label>
          <select
            id="questionType"
            name="questionType"
            [(ngModel)]="question.questionType"
            (ngModelChange)="onQuestionTypeChange()"
            required
          >
            <option value="single_choice" selected>Single Choice</option>
            <option value="multiple_choice">Multiple Choice</option>
            <option value="text_input">Text Input</option>
          </select>
        </div>
      </div>

      <div class="form-right">

    <!-- Text Input: Match Keywords -->
    <div class="choices-section" *ngIf="question.questionType === 'text_input'">
      <h3>Match Keywords</h3>
      <small>Keywords that should match in the user's answer</small>
      <div class="choice-item" *ngFor="let keyword of question.matchKeywords; let i = index; trackBy: trackByIndex">
        <div class="choice-row">
          <input
            type="text"
            [(ngModel)]="question.matchKeywords![i]"
            [name]="'keyword_' + i"
            placeholder="Enter keyword"
            required
            class="choice-input"
          />
          <button type="button" class="remove-choice-btn" (click)="removeKeyword(i)" *ngIf="question.matchKeywords!.length > 1">
            ✕
          </button>
        </div>
      </div>
      <button type="button" class="add-choice-btn" (click)="addKeyword()">+ Add Keyword</button>
    </div>

    <!-- Single Choice: Dynamic choices (1 correct + multiple wrong) -->
    <div class="choices-section" *ngIf="question.questionType === 'single_choice'">
      <h3>Correct Answer</h3>
      <div class="choice-item" *ngFor="let choice of question.choices; let i = index">
        <input
          *ngIf="choice.isGood"
          type="text"
          [(ngModel)]="choice.choiceText"
          [name]="'choice_' + i"
          placeholder="Enter the correct answer"
          required
        />
      </div>
      
      <h3>Wrong Answers</h3>
      <div class="choice-item" *ngFor="let choice of question.choices; let i = index">
        <div class="choice-row" *ngIf="!choice.isGood">
          <input
            type="text"
            [(ngModel)]="choice.choiceText"
            [name]="'choice_' + i"
            placeholder="Enter wrong answer"
            required
            class="choice-input"
          />
          <button type="button" class="remove-choice-btn" (click)="removeChoice(i)" *ngIf="getWrongChoicesCount() > 1">
            ✕
          </button>
        </div>
      </div>
      <button type="button" class="add-choice-btn" (click)="addChoice()">+ Add Wrong Answer</button>
    </div>

    <!-- Multiple Choice: Dynamic choices (at least 1 correct) -->
    <div class="choices-section" *ngIf="question.questionType === 'multiple_choice'">
      <h3>Answer Choices</h3>
      <div class="choice-item" *ngFor="let choice of question.choices; let i = index">
        <div class="choice-row">
          <input
            type="text"
            [(ngModel)]="choice.choiceText"
            [name]="'choice_' + i"
            placeholder="Enter answer choice"
            required
            class="choice-input"
          />
          <label class="choice-checkbox">
            <input
              type="checkbox"
              [(ngModel)]="choice.isGood"
              [name]="'isGood_' + i"
            />
            Correct
          </label>
          <button type="button" class="remove-choice-btn" (click)="removeChoice(i)" *ngIf="question.choices!.length > 1">
            ✕
          </button>
        </div>
      </div>
      <button type="button" class="add-choice-btn" (click)="addChoice()">+ Add Choice</button>
    </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="submit-button" *ngIf="!isEditMode" [disabled]="questionForm.invalid">Create Question</button>
      <button type="submit" class="submit-button" *ngIf="isEditMode" [disabled]="questionForm.invalid">Update Question</button>
      <button type="button" class="delete-button" *ngIf="isEditMode" (click)="deleteQuestion(editingQuestionId!)">Delete Question</button>
      <button type="button" class="cancel-button" *ngIf="isEditMode" (click)="cancelEdit()">Cancel</button>
    </div>
  </form>

  <div class="questions-list">
    <h2>Modify or Delete Questions ({{ allQuestions.length }})</h2>
    
    <div class="loading-message" *ngIf="loading">
      <p>Loading questions...</p>
    </div>
    
    <div class="no-questions" *ngIf="!loading && allQuestions.length === 0">
      <p>No questions yet. Create your first question above.</p>
    </div>
    
    <div class="table-container" *ngIf="allQuestions.length > 0">
      <table class="questions-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Question Text</th>
            <th>Difficulty</th>
            <th>Type</th>
            <th>Topic</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let q of allQuestions" 
              (click)="editQuestion(q)"
              [class.selected]="editingQuestionId === q.id"
              [class.inactive-question]="!q.isActive"
              class="clickable-row">
            <td data-label="ID">{{ q.id }}</td>
            <td data-label="Question Text" class="question-text">{{ stripHtml(q.questionText) }}</td>
            <td data-label="Difficulty">
              <span class="badge" [ngClass]="'badge-' + q.difficulty">{{ q.difficulty }}</span>
            </td>
            <td data-label="Type">
              <span class="type-badge" [ngClass]="'type-badge-' + q.questionType">{{ q.questionType === 'single_choice' ? 'Single' : q.questionType === 'multiple_choice' ? 'Multiple' : 'Text' }}</span>
            </td>
            <td data-label="Topic">{{ q.topic }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
