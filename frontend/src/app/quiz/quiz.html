<div class="quiz-container">
  <!-- Confirmation Dialog -->
  <app-confirmation-dialog
    [isOpen]="showConfirmationDialog"
    title="Leave Quiz?"
    [message]="'You have answered ' + questionsAnswered + ' question(s). Are you sure you want to leave?'"
    confirmText="Leave"
    (confirmed)="onDialogConfirmed()"
    (cancelled)="onDialogCancelled()"
  ></app-confirmation-dialog>

  <div class="card">
    <div *ngIf="loading" class="loading">Loading quiz...</div>
    <div *ngIf="error" class="error">{{ error }}</div>

    <!-- Mode Selection Screen -->
    <div *ngIf="showModeSelection" class="mode-selection">
      <h2>Choose Quiz Mode</h2>
      <div class="modes-grid">
        <button
          *ngFor="let mode of quizModes"
          class="mode-button"
          (click)="selectMode(mode)"
        >
          <div class="mode-title">{{ mode.name }}</div>
          <div class="mode-description">{{ mode.description }}</div>
        </button>
      </div>
    </div>

    <!-- Leaderboard Mode Toggle - Hidden during quiz -->
    <div *ngIf="false" class="leaderboard-toggle-section">
      <div class="toggle-container">
        <span class="toggle-label">Challenge Mode (Leaderboard):</span>
        <button 
          class="toggle-btn"
          [class.active]="!leaderboardMode"
          (click)="leaderboardMode = false"
        >
          Normal (10 questions)
        </button>
        <button 
          class="toggle-btn"
          [class.active]="leaderboardMode"
          (click)="toggleLeaderboardMode()"
        >
          Challenge (until fail)
        </button>
        <span *ngIf="leaderboardMode" class="streak-display">Streak: {{ streak }} | Best: {{ maxStreak }}</span>
      </div>
    </div>
    <div *ngIf="leaderboardMode" class="leaderboard-streak">
      Current Streak: {{ streak }} | Max Streak: {{ maxStreak }}
    </div>

    <!-- Achievement Notification - Below Header -->
    <div *ngIf="showAchievementNotification && awardedAchievements.length > 0" class="achievement-notification">
      <div class="achievement-content">
        <div class="achievement-header">Achievement Unlocked!</div>
        <div *ngIf="awardedAchievements[currentAchievementIndex]" class="achievement-details">
          <div class="achievement-icon-container">
            <div 
              class="achievement-icon"
              [style.backgroundPosition]="getAchievementBackgroundPosition(awardedAchievements[currentAchievementIndex].sprite_col, awardedAchievements[currentAchievementIndex].sprite_row)"
            ></div>
          </div>
          <h3 class="achievement-title">{{ awardedAchievements[currentAchievementIndex].title }}</h3>
          <p class="achievement-description">{{ awardedAchievements[currentAchievementIndex].description }}</p>
        </div>
        <div *ngIf="awardedAchievements.length > 1" class="achievement-counter">
          {{ currentAchievementIndex + 1 }} / {{ awardedAchievements.length }}
        </div>
      </div>
    </div>

    <div *ngIf="!loading && !error && !isQuizComplete && !showModeSelection && currentQuestion">
      <div class="quiz-header">
        <div class="topics">
          <span class="topic">{{ currentQuestion.topic }}</span>
        </div>
        <div class="quiz-mode-header">
          <span class="selected-mode">{{ selectedMode?.name }} Questions</span>
        </div>
        <span class="difficulty" [class]="currentQuestion.difficulty">
          {{ currentQuestion.difficulty }}
        </span>
      </div>

      <div class="quiz-question" [innerHTML]="currentQuestion.question"></div>

      <div class="answer-area">
        <!-- Text Input -->
        <div *ngIf="currentQuestion.questionType === 'text_input'" class="text-input-area">
          <div *ngIf="textAnswers.length > 0; else singleInput">
            <div *ngFor="let answer of textAnswers; let i = index; trackBy: trackByIndex" class="text-input-group">
              <div class="text-input-with-icon">
                <input
                  type="text"
                  class="text-answer-input"
                  [class.correct-answer]="answered && textAnswersCorrect[i]"
                  [class.wrong-answer]="answered && !textAnswersCorrect[i]"
                  [(ngModel)]="textAnswers[i]"
                  [placeholder]="'Answer ' + (i + 1)"
                  [disabled]="answered"
                  (keyup.enter)="canSubmit && submitAnswer()"
                />
                <span *ngIf="answered && textAnswersCorrect[i]" class="text-input-icon correct-icon">âœ“</span>
                <span *ngIf="answered && !textAnswersCorrect[i]" class="text-input-icon wrong-icon">âœ—</span>
              </div>
              <div *ngIf="answered && !textAnswersCorrect[i] && getMissingKeyword(i)" class="text-input-with-icon">
                <input
                  type="text"
                  class="text-answer-input correct-answer-display"
                  [value]="getMissingKeyword(i)"
                  readonly
                />
                <span class="text-input-icon correct-icon">âœ“</span>
              </div>
            </div>
          </div>
          <ng-template #singleInput>
            <input
              type="text"
              class="text-answer-input"
              [class.correct-answer]="answered && correct"
              [class.wrong-answer]="answered && !correct"
              [(ngModel)]="textAnswer"
              placeholder="Type your answer..."
              [disabled]="answered"
              (keyup.enter)="canSubmit && submitAnswer()"
            />
          </ng-template>
        </div>

        <!-- Single/Multiple Choice -->
        <div *ngIf="currentQuestion.questionType === 'single_choice' || currentQuestion.questionType === 'multiple_choice'" class="choices-area">
          <div
            *ngFor="let choice of displayChoices; let i = index"
            class="choice"
            [class.selected]="choice.selected"
            [class.correct-choice]="answered && choice.selected && choice.isGood"
            [class.wrong-choice]="answered && ((choice.selected && !choice.isGood) || (!choice.selected && choice.isGood))"
            [class.disabled]="answered"
            (click)="selectChoice(i)"
          >
            <div class="choice-checkbox">
              <span *ngIf="currentQuestion.questionType === 'single_choice'" class="radio" [class.checked]="choice.selected"></span>
              <span *ngIf="currentQuestion.questionType === 'multiple_choice'" class="checkbox" [class.checked]="choice.selected">
                <span class="checkmark" [style.visibility]="choice.selected ? 'visible' : 'hidden'">âœ“</span>
              </span>
            </div>
            <div class="choice-content">
              <div class="choice-text">{{ choice.choiceText }}</div>
              <div *ngIf="answered && !choice.isGood && choice.explanation" class="choice-explanation-text" [class.not-selected]="!choice.selected">
                {{ choice.explanation }}
              </div>
            </div>
            <div class="choice-indicator" [class.visible]="answered">
              <span *ngIf="answered && choice.isGood !== undefined && choice.isGood" class="correct-icon">âœ“</span>
              <span *ngIf="answered && choice.isGood !== undefined && !choice.isGood && choice.selected" class="wrong-icon">âœ—</span>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group" *ngIf="!answered">
        <button
          *ngIf="canSubmit"
          class="btn btn-primary"
          (click)="submitAnswer()"
        >
          Submit Answer
        </button>
        <button
          *ngIf="!canSubmit && canSkip"
          class="btn btn-secondary"
          (click)="skipQuestion()"
        >
          Skip Question
        </button>
      </div>

      <div *ngIf="answered && longAnswer" class="answer-section">
        <div class="quiz-answer" [innerHTML]="longAnswer"></div>
      </div>

      <!-- Show skipped correct answers after the answer section -->
      <div *ngIf="answered && currentQuestion.questionType === 'multiple_choice' && skippedCorrectChoices.length > 0" class="skipped-answers-section">
        <h3>Other Correct Answers:</h3>
        <div class="skipped-answers-list">
          <div *ngFor="let choice of skippedCorrectChoices" class="skipped-answer-item">
            {{ choice.choiceText }}
          </div>
        </div>
      </div>

      <div class="button-group" *ngIf="answered">
        <button
          class="btn btn-secondary"
          *ngIf="currentQuestionNumber < totalQuestions"
          (click)="nextQuestion()"
        >
          Next Question
        </button>

        <button
          class="btn btn-success"
          *ngIf="currentQuestionNumber === totalQuestions"
          (click)="nextQuestion()"
        >
          Finish Quiz
        </button>
      </div>
    </div>

    <div *ngIf="isQuizComplete" class="quiz-complete">
      <h2>Quiz Complete! ðŸŽ‰</h2>
      <div *ngIf="leaderboardMode">
        <p>Streak: {{ streak }} / {{ totalQuestions }}</p>
        <p>Best Streak: {{ maxStreak }}</p>
      </div>
      <div *ngIf="!leaderboardMode">
        <p>You've completed all {{ totalQuestions }} questions.</p>
      </div>
      <button class="btn btn-primary" (click)="restartQuiz()">
        Choose Different Mode
      </button>
    </div>
  </div>

  <div *ngIf="!loading && !error && !isQuizComplete && !showModeSelection" class="progress-counter">
    {{ currentQuestionNumber }} / {{ totalQuestions }}
  </div>
</div>
