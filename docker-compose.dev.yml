# Development override - enables hot reload with volume mounts and watch mode
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
services:
  auth:
    env_file:
      - ./.env
    volumes:
      - ./services/auth/src:/app/services/auth/src
      - ./services/auth/package.json:/app/services/auth/package.json
      - ./services/auth/node_modules:/app/services/auth/node_modules
      - ./packages/events:/app/packages/events
      - ./packages/messaging:/app/packages/messaging
    environment:
      - NODE_ENV=development
    command: sh -c "npm install && npm run dev"

  questions:
    env_file:
      - ./.env
    volumes:
      - ./services/questions/src:/app/src
      - ./services/questions/package.json:/app/package.json
      - ./services/questions/node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
    command: sh -c "npm install && npm run dev"

  quiz:
    env_file:
      - ./.env
    volumes:
      - ./services/quiz/src:/app/services/quiz/src
      - ./services/quiz/package.json:/app/services/quiz/package.json
      - ./services/quiz/node_modules:/app/services/quiz/node_modules
      - ./packages/events:/app/packages/events
      - ./packages/messaging:/app/packages/messaging
    environment:
      - NODE_ENV=development
    command: sh -c "cd /app/packages/events && npm install && npm run build && cd /app/packages/messaging && npm install && npm run build && cd /app/services/quiz && npm install && npm run start:dev"

  achievements:
    env_file:
      - ./.env
    volumes:
      - ./services/achievements/src:/app/services/achievements/src
      - ./services/achievements/package.json:/app/services/achievements/package.json
      - ./services/achievements/node_modules:/app/services/achievements/node_modules
      - ./packages/events:/app/packages/events
      - ./packages/messaging:/app/packages/messaging
    environment:
      - NODE_ENV=development
    command: sh -c "cd /app/packages/events && npm install && npm run build && cd /app/packages/messaging && npm install && npm run build && cd /app/services/achievements && npm install && npm run start:dev"

  leaderboard:
    env_file:
      - ./.env
    volumes:
      - ./services/leaderboard/src:/app/services/leaderboard/src
      - ./services/leaderboard/package.json:/app/services/leaderboard/package.json
      - ./services/leaderboard/node_modules:/app/services/leaderboard/node_modules
      - ./packages/events:/app/packages/events
      - ./packages/messaging:/app/packages/messaging
    environment:
      - NODE_ENV=development
    command: sh -c "cd /app/packages/events && npm install && npm run build && cd /app/packages/messaging && npm install && npm run build && cd /app/services/leaderboard && npm install && npm run start:dev"

  maintenance:
    env_file:
      - ./.env
    volumes:
      - ./services/maintenance/src:/app/src
      - ./services/maintenance/package.json:/app/package.json
      - ./services/maintenance/node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
    command: sh -c "npm install && npm run dev"

  admin:
    env_file:
      - ./.env
    volumes:
      - ./services/admin/src:/app/services/admin/src
      - ./services/admin/package.json:/app/services/admin/package.json
      - ./services/admin/node_modules:/app/services/admin/node_modules
      - ./packages/events:/app/packages/events
      - ./packages/messaging:/app/packages/messaging
    environment:
      - NODE_ENV=development
    command: sh -c "cd /app/packages/events && npm install && npm run build && cd /app/packages/messaging && npm install && npm run build && cd /app/services/admin && npm install && npm run start:watch"

  api-gateway:
    env_file:
      - ./.env
    volumes:
      - ./services/api-gateway/src:/app/src
      - ./services/api-gateway/package.json:/app/package.json
      - ./services/api-gateway/node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
    command: sh -c "npm install && npm run dev"

  frontend:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./frontend:/app
      - ./frontend/node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - API_GATEWAY_URL=http://api-gateway:3000
    command: sh -c "npm install && npm start -- --host 0.0.0.0 --port 80"
